/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var V=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var _=(g,i)=>{for(var e in i)V(g,e,{get:i[e],enumerable:!0})},Z=(g,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of Q(i))!J.call(g,s)&&s!==e&&V(g,s,{get:()=>i[s],enumerable:!(t=Y(i,s))||t.enumerable});return g};var ee=g=>Z(V({},"__esModule",{value:!0}),g);var ie={};_(ie,{default:()=>q});module.exports=ee(ie);var y=require("obsidian");var k={transitionSeconds:30,minSessionSeconds:300,showStatusBar:!0,showWorkspaceBorder:!0,borderOpacity:.3,enableApi:!1,apiPort:3030,enableAuthentication:!0,enableSync:!1,syncInterval:5,deviceId:"",deviceName:"Obsidian Device",showPeriodicReminder:!1,reminderIntervalMinutes:1},I="role-switch-view";var p=class{static generateId(){return Math.random().toString(36).substring(2,9)}static formatDuration(i){if(i<60)return`${Math.round(i)}min`;let e=Math.floor(i/60),t=Math.round(i%60);return t===0?`${e}h`:`${e}h ${t}min`}static formatTime(i){return i.toLocaleTimeString("en",{hour:"2-digit",minute:"2-digit",hour12:!1})}static getStartOfDay(i=new Date){let e=new Date(i);return e.setHours(0,0,0,0),e}static getStartOfWeek(i=new Date){let e=new Date(i);return e.setDate(i.getDate()-i.getDay()),e.setHours(0,0,0,0),e}static getStartOfMonth(i=new Date){return new Date(i.getFullYear(),i.getMonth(),1)}static calculateSessionDuration(i,e){return i.endAt?(new Date(i.endAt).getTime()-new Date(i.startAt).getTime())/(1e3*60):i.id===e?(Date.now()-new Date(i.startAt).getTime())/(1e3*60):0}static deriveSessionsFromEvents(i,e,t){var o,r;let s=[],n=i.slice().sort((u,c)=>new Date(u.at).getTime()-new Date(c.at).getTime()),a=null;for(let u of n){let c=new Date(u.at);if(!(e&&c<e)&&!(t&&c>t))switch(u.type){case"start":a={id:((o=u.meta)==null?void 0:o.sessionId)||p.generateId(),roleId:u.roleId,startAt:u.at,notes:[]};break;case"end":a&&a.roleId===u.roleId&&(s.push({...a,endAt:u.at}),a=null);break;case"switch":a&&s.push({...a,endAt:u.at}),a={id:((r=u.meta)==null?void 0:r.sessionId)||p.generateId(),roleId:u.roleId,startAt:u.at,notes:[]};break}}return a&&a.startAt&&s.push(a),s}static getSessionsWithDurations(i,e,t,s){return p.deriveSessionsFromEvents(i,e,t).map(a=>({...a,durationMinutes:p.calculateSessionDuration(a,s)}))}static calculateAnalytics(i){let e=i.reduce((a,o)=>a+o.durationMinutes,0),t=i.length,s=t>0?e/t:0,n={};return i.forEach(a=>{n[a.roleId]||(n[a.roleId]={totalMinutes:0,sessionCount:0}),n[a.roleId].totalMinutes+=a.durationMinutes,n[a.roleId].sessionCount+=1}),{totalMinutes:e,switchCount:t,avgSessionDuration:s,roleStats:n}}static exportToCSV(i,e=[]){let s=[["Date","Start Time","End Time","Duration (min)","Role ID","Session ID","Notes"]];return i.forEach(n=>{let a=new Date(n.startAt),o=n.endAt?new Date(n.endAt):null,r=o?Math.round((o.getTime()-a.getTime())/(1e3*60)):"Ongoing",c=e.filter(l=>n.notes.some(h=>h.id===l.id)).map(l=>l.text).join("; ");s.push([a.toLocaleDateString(),p.formatTime(a),o?p.formatTime(o):"Ongoing",r.toString(),n.roleId,n.id,c])}),s.map(n=>n.map(a=>`"${a.toString().replace(/"/g,'""')}"`).join(",")).join(`
`)}static exportToJSON(i,e=[]){let t={exportDate:new Date().toISOString(),sessions:i.map(s=>({...s,notes:e.filter(n=>s.notes.some(a=>a.id===n.id))}))};return JSON.stringify(t,null,2)}static debounce(i,e){let t;return(...s)=>{clearTimeout(t),t=setTimeout(()=>i(...s),e)}}static isValidHexColor(i){return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(i)}static generateRandomColor(){let i=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#34495e","#e67e22","#8e44ad","#27ae60","#2980b9","#f1c40f","#d35400","#c0392b","#16a085"];return i[Math.floor(Math.random()*i.length)]}};var b=require("obsidian");var m=class{static getIcon(i){return this.ICONS[i]||this.ICONS.A}static renderIcon(i,e=24,t="currentColor"){return this.getIcon(i).replace('fill="currentColor"',`fill="${t}"`).replace('viewBox="0 0 24 24"',`viewBox="0 0 24 24" width="${e}" height="${e}"`)}static createIconElement(i,e=24,t="currentColor"){let s=document.createElement("div");s.addClass("icon-element-container"),s.setCssProps({"--icon-size":e+"px","--icon-color":t});let n=this.getIcon(i);if(n)try{let r=new DOMParser().parseFromString(n,"image/svg+xml").querySelector("svg");if(r){r.setAttribute("width",e.toString()),r.setAttribute("height",e.toString()),r.setAttribute("fill",t);let u=document.importNode(r,!0);s.appendChild(u)}else s.textContent=i.charAt(0).toUpperCase(),s.addClass("icon-fallback-text")}catch(a){s.textContent=i.charAt(0).toUpperCase(),s.addClass("icon-fallback-text")}else s.textContent=i.charAt(0).toUpperCase(),s.addClass("icon-fallback-text");return s}static getAllIcons(){return Object.keys(this.ICONS)}static getIconsByCategory(){return{"A-G":["A","B","C","D","E","F","G"],"H-N":["H","I","J","K","L","M","N"],"O-U":["O","P","Q","R","S","T","U"],"V-Z":["V","W","X","Y","Z"]}}};m.ICONS={A:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">A</text></svg>',B:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">B</text></svg>',C:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">C</text></svg>',D:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">D</text></svg>',E:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">E</text></svg>',F:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">F</text></svg>',G:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">G</text></svg>',H:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">H</text></svg>',I:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">I</text></svg>',J:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">J</text></svg>',K:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">K</text></svg>',L:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">L</text></svg>',M:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">M</text></svg>',N:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">N</text></svg>',O:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">O</text></svg>',P:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">P</text></svg>',Q:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">Q</text></svg>',R:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">R</text></svg>',S:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">S</text></svg>',T:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">T</text></svg>',U:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">U</text></svg>',V:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">V</text></svg>',W:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">W</text></svg>',X:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">X</text></svg>',Y:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">Y</text></svg>',Z:'<svg viewBox="0 0 24 24" fill="currentColor"><text x="12" y="18" text-anchor="middle" font-size="18" font-weight="bold" font-family="Arial, sans-serif">Z</text></svg>'};var v=require("obsidian");function te(g){return g&&"basePath"in g&&typeof g.basePath=="string"}var N=class extends v.Modal{constructor(e,t,s){super(e);this.countdownInterval=null;this.plugin=t,this.targetRole=s,this.remainingSeconds=t.data.settings.transitionSeconds}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("transition-modal"),v.Platform.isMobile&&e.addClass("mobile"),e.createEl("div",{text:`Switching to: ${this.targetRole.name}`,cls:"transition-title role-color-text"}).setCssProps({"--role-color":this.targetRole.colorHex});let s=e.createEl("div",{text:`${this.remainingSeconds}s`,cls:"transition-countdown"}),n=N.TRANSITION_MESSAGES[Math.floor(Math.random()*N.TRANSITION_MESSAGES.length)];e.createEl("div",{text:n,cls:"transition-message"});let o=e.createDiv({cls:"transition-buttons"}).createEl("button",{text:"Cancel"});v.Platform.isMobile&&o.addClass("mobile"),this.countdownInterval=window.setInterval(()=>{this.remainingSeconds--,s.setText(`${this.remainingSeconds}s`),this.remainingSeconds<=0&&(this.plugin.confirmSwitch(this.targetRole.id),this.countdownInterval&&clearInterval(this.countdownInterval),this.close())},1e3),o.addEventListener("click",()=>{this.plugin.data.events.push({id:p.generateId(),type:"cancelTransition",roleId:this.targetRole.id,at:new Date().toISOString(),meta:{fromRoleId:this.plugin.data.state.activeRoleId||void 0,transitionSeconds:this.plugin.data.settings.transitionSeconds}}),this.close()})}onClose(){this.countdownInterval&&clearInterval(this.countdownInterval);let{contentEl:e}=this;e.empty()}},A=N;A.TRANSITION_MESSAGES=["Studies show that it takes an average of 20-25 minutes to re-enter a state of deep flow when switching to a completely different task.","If you intentionally create a 'switch buffer,' your brain will recognize that 'you're in a different mode,' making it easier to shift your mindset.","Taking a moment to pause between roles helps you mentally close the previous task and prepare for the next one with full attention.","This transition time allows your mind to let go of the previous context and embrace the new role without carrying over distractions.","Brief pauses between different types of work reduce cognitive load and help maintain higher quality focus in each role."];var C=class extends v.Modal{constructor(e,t,s="start"){super(e);this.plugin=t,this.mode=s}onOpen(){let{contentEl:e}=this;e.empty(),v.Platform.isMobile&&e.addClass("role-picker-modal");let t=this.mode==="start"?"Start Role":"Switch Role";if(e.createEl("h2",{text:t}),this.plugin.data.roles.length===0){e.createDiv({text:"No roles created yet. Create roles in settings first.",cls:"modal-no-content"});return}let s=e.createDiv({cls:`role-picker-grid ${v.Platform.isMobile?"mobile":""}`});this.plugin.data.roles.forEach(n=>{this.createRoleCard(s,n)})}createRoleCard(e,t){let s=this.plugin.data.state.activeRoleId===t.id,n=e.createDiv({cls:`role-card-picker ${s?"active role-color-border":""}`});s&&n.setCssProps({"--role-color":t.colorHex}),n.addEventListener("mouseenter",()=>{s||(n.addClass("role-color-border"),n.setCssProps({"--role-color":t.colorHex}))}),n.addEventListener("mouseleave",()=>{s||n.removeClass("role-color-border")});let a=n.createDiv({cls:"role-icon-picker role-color-bg"});if(a.setCssProps({"--role-color":t.colorHex}),t.icon&&m.ICONS[t.icon]){let r=m.createIconElement(t.icon,20,"white");a.appendChild(r)}let o=n.createEl("h3",{text:t.name,cls:`role-name-picker ${s?"active role-color-text":""}`});s&&o.setCssProps({"--role-color":t.colorHex}),t.description&&n.createDiv({text:t.description,cls:"role-description-picker"}),s&&n.createDiv({text:"\u25CF Active",cls:"role-status-active role-color-text"}).setCssProps({"--role-color":t.colorHex}),n.addEventListener("click",r=>{if(r.stopPropagation(),s&&this.mode==="switch"){new v.Notice("Already in this role");return}this.mode==="start"?this.plugin.startSession(t.id):this.plugin.switchSession(t.id),setTimeout(()=>this.close(),0)})}onClose(){let{contentEl:e}=this;e.empty()}},B=class extends v.Modal{constructor(e,t,s,n=null){super(e);this.plugin=t,this.sessionId=s,this.note=n}onOpen(){let{contentEl:e}=this;e.empty();let t=this.note?"Edit Note":"Add Note";e.createEl("h2",{text:t}),this.textArea=e.createEl("textarea",{cls:"note-edit-textarea"}),this.note&&(this.textArea.value=this.note.text);let s=e.createDiv({cls:"note-edit-buttons"});s.createEl("button",{text:"Save",cls:"note-edit-save"}).addEventListener("click",()=>this.save()),this.note&&s.createEl("button",{text:"Delete",cls:"note-edit-delete"}).addEventListener("click",()=>this.delete()),this.textArea.focus()}save(){let e=this.textArea.value.trim();if(!e){new v.Notice("Note text cannot be empty");return}try{this.note?(this.plugin.updateNote(this.note.id,e),new v.Notice("Note updated")):(this.plugin.addNote(this.sessionId,e),new v.Notice("Note added")),this.close()}catch(t){new v.Notice("Failed to save note")}}delete(){if(this.note)try{this.plugin.deleteNote(this.note.id),new v.Notice("Note deleted"),this.close()}catch(e){new v.Notice("Failed to delete note")}}onClose(){let{contentEl:e}=this;e.empty()}},E=class extends v.Modal{constructor(e,t){super(e);this.timerInterval=null;this.durationEl=null;this.lockEl=null;this.plugin=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("dashboard-modal"),v.Platform.isMobile&&e.addClass("mobile");let t=e.createDiv({cls:"dashboard-header"});if(!v.Platform.isMobile)try{let s=this.app.vault.adapter;if(te(s)){let n=this.app.vault.configDir,a=`${s.basePath}/${n}/plugins/obsidian-role-switch`,o=t.createEl("img",{attr:{src:`app://local/${a}/image/logo.png`,alt:"RoleSwitch Logo"},cls:"dashboard-logo size-32"});o.addEventListener("error",()=>{o.remove()})}}catch(s){}t.createEl("h2",{text:"Role Dashboard",cls:"dashboard-header-title"}),this.createAnalyticsSection(e),this.createCurrentStatusSection(e),this.startRealtimeTimer()}createAnalyticsSection(e){let t=e.createDiv({cls:"analytics-section-dashboard"});t.createEl("h3",{text:"\u{1F4CA} Analytics",cls:"analytics-section-title"});let s=p.getStartOfDay(),n=this.plugin.getDerivedSessions(s,new Date),a=n.reduce((D,S)=>S.endAt?D+(new Date(S.endAt).getTime()-new Date(S.startAt).getTime())/(1e3*60):S.id===this.plugin.data.state.activeSessionId?D+(Date.now()-new Date(S.startAt).getTime())/(1e3*60):D,0),o=n.length,r=p.getStartOfWeek(),c=this.plugin.getDerivedSessions(r,new Date).reduce((D,S)=>S.endAt?D+(new Date(S.endAt).getTime()-new Date(S.startAt).getTime())/(1e3*60):S.id===this.plugin.data.state.activeSessionId?D+(Date.now()-new Date(S.startAt).getTime())/(1e3*60):D,0),l=c/7,h=p.getStartOfMonth(),w=this.plugin.getDerivedSessions(h,new Date).reduce((D,S)=>S.endAt?D+(new Date(S.endAt).getTime()-new Date(S.startAt).getTime())/(1e3*60):S.id===this.plugin.data.state.activeSessionId?D+(Date.now()-new Date(S.startAt).getTime())/(1e3*60):D,0),R=new Date(s.getFullYear(),s.getMonth()+1,0).getDate(),X=w/R,F=t.createDiv({cls:`analytics-grid-dashboard ${v.Platform.isMobile?"mobile":""}`}),U=F.createDiv({cls:"analytics-card-dashboard"});U.createEl("h4",{text:"Today",cls:"analytics-card-title"}),U.createEl("div",{text:`${Math.round(a)}min total`,cls:"analytics-stat-text"}),U.createEl("div",{text:`${o} switches`,cls:"analytics-stat-text-muted"});let W=F.createDiv({cls:"analytics-card-dashboard"});W.createEl("h4",{text:"Averages",cls:"analytics-card-title"}),W.createEl("div",{text:`${Math.round(l)}min/day (week)`,cls:"analytics-stat-text"}),W.createEl("div",{text:`${Math.round(X)}min/day (month)`,cls:"analytics-stat-text-muted"});let z=F.createDiv({cls:`analytics-card-dashboard analytics-card-totals ${v.Platform.isMobile?"mobile":""}`});z.createEl("h4",{text:"Totals",cls:"analytics-card-title"});let j=z.createDiv({cls:"analytics-totals-grid"});j.createEl("div",{text:`Week: ${Math.round(c)}min`,cls:"analytics-totals-text"}),j.createEl("div",{text:`Month: ${Math.round(w)}min`,cls:"analytics-totals-text"})}createCurrentStatusSection(e){let t=e.createDiv({cls:"current-status-dashboard"});if(t.createEl("h3",{text:"Current Session",cls:"session-header-title"}),this.plugin.data.state.activeRoleId){let s=this.plugin.data.roles.find(n=>n.id===this.plugin.data.state.activeRoleId);if(s){let n=t.createDiv({cls:"active-info"}),a=n.createDiv({cls:"active-role-dot role-color-bg"});if(a.setCssProps({"--role-color":s.colorHex}),s.icon&&m.ICONS[s.icon]){let r=m.createIconElement(s.icon,12,"white");r.addClass("icon-filter-shadow"),a.appendChild(r)}let o=n.createDiv();if(o.createEl("strong",{text:`Active: ${s.name}`,cls:"active-role-name"}),this.plugin.data.state.activeStartAt&&(this.durationEl=o.createEl("div",{text:"Duration: 0s",cls:"active-duration"}),this.updateDurationDisplay()),this.plugin.isSessionLocked()){let r=this.plugin.getRemainingLockTime();this.lockEl=t.createDiv({text:`\u{1F512} Session locked for ${r} more seconds`,cls:"session-locked-warning"})}}}else t.createDiv({text:"\u23F8\uFE0F No active session",cls:"no-session-notice"});this.createTodayHistorySection(t)}createTodayHistorySection(e){let t=p.getStartOfDay(),s=this.plugin.getDerivedSessions(t,new Date);if(s.length>0){e.createEl("h4",{text:"Today's History",cls:"history-section-title"});let n=e.createDiv({cls:"history-container"});s.forEach(a=>{let o=this.plugin.data.roles.find(r=>r.id===a.roleId);if(o){let r=n.createDiv({cls:"history-session-item"});r.createDiv({cls:"history-role-indicator role-color-bg"}).setCssProps({"--role-color":o.colorHex});let c=r.createDiv(),l=new Date(a.startAt).toLocaleTimeString("en",{hour:"2-digit",minute:"2-digit"}),h=0;a.endAt?h=Math.round((new Date(a.endAt).getTime()-new Date(a.startAt).getTime())/(1e3*60)):a.id===this.plugin.data.state.activeSessionId&&(h=Math.round((Date.now()-new Date(a.startAt).getTime())/(1e3*60))),c.createEl("div",{text:`${o.name} \u2022 ${l} \u2022 ${h}min`,cls:"history-session-details"})}})}}startRealtimeTimer(){this.timerInterval&&clearInterval(this.timerInterval),this.plugin.data.state.activeRoleId&&this.plugin.data.state.activeStartAt&&(this.timerInterval=window.setInterval(()=>{this.updateDurationDisplay(),this.updateLockDisplay()},1e3))}updateDurationDisplay(){if(!this.durationEl||!this.plugin.data.state.activeStartAt)return;let e=new Date(this.plugin.data.state.activeStartAt),t=Date.now(),s=Math.floor((t-e.getTime())/1e3),n=Math.floor(s/3600),a=Math.floor(s%3600/60),o=s%60,r="";n>0?r=`${n}h ${a}m ${o}s`:a>0?r=`${a}m ${o}s`:r=`${o}s`,this.durationEl.setText(`Duration: ${r}`)}updateLockDisplay(){if(this.lockEl)if(this.plugin.isSessionLocked()){let e=this.plugin.getRemainingLockTime();this.lockEl.setText(`\u{1F512} Session locked for ${e} more seconds`)}else this.lockEl.remove(),this.lockEl=null}onClose(){this.timerInterval&&clearInterval(this.timerInterval);let{contentEl:e}=this;e.empty()}},M=class extends v.Modal{constructor(e,t,s){super(e);this.selectedIcon=null;this.updateButtonState=null;this.onSelectIcon=t,this.selectedIcon=s||null}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Select Icon"});let t=e.createDiv({cls:"icon-picker-container"}),s=t.createDiv({cls:"icon-grid"}),n=m.getAllIcons();n.length===0?t.createDiv({text:"No icons available",cls:"no-icons-available"}):n.forEach(u=>{this.createIconButton(s,u)}),this.updateSelectedDisplay(e);let a=e.createDiv({cls:"icon-picker-buttons"}),o=a.createEl("button",{text:"Select"});o.disabled=!this.selectedIcon,o.addEventListener("click",()=>{this.selectedIcon&&(this.onSelectIcon(this.selectedIcon),this.close())}),a.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),this.updateButtonState=u=>{o.disabled=!u}}createIconButton(e,t){let s=this.selectedIcon===t,n=e.createDiv({cls:`icon-button ${s?"selected":""}`,attr:{"data-icon-key":t,title:t}}),a=n.createDiv({cls:`icon-element ${s?"selected":""}`});try{let o=m.createIconElement(t,20,s?"#007acc":"#666");a.appendChild(o)}catch(o){a.textContent=t.charAt(0).toUpperCase()}n.addEventListener("click",()=>{this.selectedIcon=t,n.parentElement instanceof HTMLElement&&this.updateIconGrid(n.parentElement),this.updateSelectedDisplay(this.contentEl),this.updateButtonState&&this.updateButtonState(!0)})}updateIconGrid(e){let t=e.parentElement;if(!t)return;t.querySelectorAll('div[style*="display: grid"]').forEach(n=>{let a=n.children;for(let o=0;o<a.length;o++){let r=a[o];if(!(r instanceof HTMLElement))continue;let u=r.getAttribute("data-icon-key"),c=u===this.selectedIcon;c?r.addClass("selected"):r.removeClass("selected");let l=r.querySelector(".icon-element");if(l instanceof HTMLElement&&u){l.empty();try{let h=m.createIconElement(u,20,c?"#007acc":"#666");l.appendChild(h)}catch(h){l.textContent=u.charAt(0).toUpperCase()}}}})}updateSelectedDisplay(e){}onClose(){let{contentEl:e}=this;e.empty()}};function se(g){return g&&"basePath"in g&&typeof g.basePath=="string"}var P=class extends b.ItemView{constructor(e,t){super(e);this.timerInterval=null;this.durationElement=null;this.lockElement=null;this.roleLockElements=new Map;this.endSessionButton=null;this.plugin=t}getViewType(){return I}getDisplayText(){return"RoleSwitch"}getIcon(){return"clock"}async onOpen(){let e=this.containerEl.children[1];if(e&&e instanceof HTMLElement){e.empty(),e.addClass("role-switch-view"),this.addSidePanelStyles();try{this.createSidePanelDashboard(e)}catch(t){this.createFallbackDashboard(e)}}}async onClose(){this.stopRealtimeTimer()}addSidePanelStyles(){if(document.getElementById("role-switch-side-panel-styles"))return;let e=document.createElement("style");e.id="role-switch-side-panel-styles",e.textContent=`
			.role-switch-view {
				padding: 16px;
				height: 100%;
				overflow-y: auto;
			}
			
			.role-switch-view .side-panel-header {
				display: flex;
				align-items: center;
				gap: 8px;
				margin-bottom: 16px;
			}
			
			.role-switch-view .header-icon {
				width: 20px;
				height: 20px;
				display: flex;
				align-items: center;
				justify-content: center;
				color: var(--interactive-accent);
			}
		`,document.head.appendChild(e)}createSidePanelDashboard(e){let t=e.createDiv({cls:"side-panel-header"}),s=t.createDiv({cls:"header-icon"});if(b.Platform.isMobile){let a=m.createIconElement("A",20,"var(--interactive-accent)");a.firstChild instanceof Node&&s.appendChild(a.firstChild)}else try{let a=this.app.vault.adapter;if(se(a)){let o=this.app.vault.configDir,r=`${a.basePath}/${o}/plugins/obsidian-role-switch`;s.createEl("img",{attr:{src:`app://local/${r}/image/logo.png`,alt:"RoleSwitch Logo"},cls:"header-logo size-24"}).addEventListener("error",()=>{s.empty();let c=m.createIconElement("A",20,"var(--interactive-accent)");c.firstChild instanceof Node&&s.appendChild(c.firstChild)})}}catch(a){let o=m.createIconElement("A",20,"var(--interactive-accent)");o.firstChild instanceof Node&&s.appendChild(o.firstChild)}let n=t.createEl("h2",{text:"RoleSwitch",cls:"header-title"});try{this.createCompactRolesSection(e)}catch(a){}try{this.createQuickActionsSection(e)}catch(a){}try{this.createCompactStatusSection(e)}catch(a){}}createCompactStatusSection(e){let t=e.createDiv({cls:"side-panel-section"});t.createEl("h3",{text:"Current History"});let s=t.createDiv({cls:"current-status-compact"});if(this.plugin.data.state.activeRoleId){let n=this.plugin.data.roles.find(a=>a.id===this.plugin.data.state.activeRoleId);if(n){let a=s.createDiv({cls:"status-info"}),o=a.createDiv({cls:"role-indicator role-color-bg"});if(o.setCssProps({"--role-color":n.colorHex}),n.icon&&m.ICONS[n.icon]){let c=m.createIconElement(n.icon,12,"white");c.addClass("icon-filter-shadow"),o.appendChild(c)}let r=a.createDiv({cls:"role-info"});if(r.createEl("div",{text:n.name,cls:"role-name role-color-text"}).setCssProps({"--role-color":n.colorHex}),this.plugin.data.state.activeStartAt){let c=new Date(this.plugin.data.state.activeStartAt),l=Math.floor((Date.now()-c.getTime())/1e3),h=Math.floor(l/3600),f=Math.floor(l%3600/60),w=l%60,R;h>0?R=`${h}h ${f}m ${w}s`:f>0?R=`${f}m ${w}s`:R=`${w}s`,this.durationElement=r.createEl("div",{text:R,cls:"role-duration"}),this.startRealtimeTimer()}else this.durationElement=null;if(this.plugin.isSessionLocked()){let c=this.plugin.getRemainingLockTime();this.lockElement=s.createDiv({text:`\u{1F512} Locked (${c}s)`,cls:"session-locked"})}else this.lockElement=null}}else this.stopRealtimeTimer(),this.durationElement=null,s.createDiv({text:"\u23F8\uFE0F No active session",cls:"no-active-session"});this.createTodayHistorySection(s)}createTodayHistorySection(e){let t=p.getStartOfDay(),s=this.plugin.getDerivedSessions(t,new Date);s.length>0&&(e.createDiv({cls:"history-divider"}).createEl("div",{text:"Today's History",cls:"history-header"}),s.slice(-3).forEach(o=>{let r=this.plugin.data.roles.find(u=>u.id===o.roleId);if(r){let u=e.createDiv({cls:"history-session"});u.createDiv({cls:"role-indicator role-color-bg"}).setCssProps({"--role-color":r.colorHex});let l=u.createDiv({cls:"session-info"}),h=new Date(o.startAt).toLocaleTimeString("en",{hour:"2-digit",minute:"2-digit"}),f=0;o.endAt?f=Math.round((new Date(o.endAt).getTime()-new Date(o.startAt).getTime())/(1e3*60)):o.id===this.plugin.data.state.activeSessionId&&(f=Math.round((Date.now()-new Date(o.startAt).getTime())/(1e3*60))),l.createEl("div",{text:`${r.name} \u2022 ${h} \u2022 ${f}min`,cls:"session-details"})}}),s.length>3&&e.createEl("div",{text:`+${s.length-3} more sessions`,cls:"more-sessions"}))}createQuickActionsSection(e){let t=e.createDiv({cls:"side-panel-section"});t.createEl("h3",{text:"Quick Actions"});let s=t.createDiv({cls:"quick-actions-container"});if(s.createEl("button",{text:"Dashboard",cls:"quick-action-btn"}).addEventListener("click",()=>{try{new E(this.app,this.plugin).open()}catch(a){new b.Notice(`Dashboard error: ${a instanceof Error?a.message:"Unknown error"}`)}}),this.plugin.data.state.activeRoleId){let a=this.plugin.isSessionLocked();if(this.endSessionButton=s.createEl("button",{text:"\u23F9\uFE0F End Session",cls:"quick-action-btn end-session"}),a){this.endSessionButton.disabled=!0,this.endSessionButton.addClass("locked");let o=this.plugin.getRemainingLockTime();this.endSessionButton.title=`Session locked for ${o} more seconds`}this.endSessionButton.addEventListener("click",()=>{this.plugin.isSessionLocked()||(this.plugin.endSession(),this.refresh())})}else this.endSessionButton=null}createCompactRolesSection(e){let t=e.createDiv({cls:"side-panel-section"});t.createEl("h3",{text:"Roles"});let s=t.createDiv({cls:"compact-roles-grid"});this.roleLockElements.clear(),this.plugin.data.roles.forEach(n=>{this.createCompactRoleCard(s,n)})}createCompactRoleCard(e,t){let s=this.plugin.data.state.activeRoleId===t.id,n=s&&this.plugin.isSessionLocked(),a=e.createDiv({cls:`compact-role-card ${s?"active role-color-border":""} ${n?"locked":""}`});s&&a.setCssProps({"--role-color":t.colorHex});let o=a.createDiv({cls:"compact-role-header"}),r=o.createDiv({cls:"compact-role-icon role-color-bg"});if(r.setCssProps({"--role-color":t.colorHex}),t.icon&&m.ICONS[t.icon]){let c=m.createIconElement(t.icon,10,"white");c.addClass("icon-filter-shadow"),r.appendChild(c)}if(o.createDiv({cls:"role-info"}).createEl("div",{text:t.name,cls:"compact-role-name"}),n){let c=this.plugin.getRemainingLockTime(),l=a.createDiv({text:`\u{1F512} ${c}s`,cls:"lock-status"});this.roleLockElements.set(t.id,l)}a.addEventListener("click",c=>{n||(a.addClass("clicked"),setTimeout(()=>a.removeClass("clicked"),200),s?new E(this.app,this.plugin).open():(this.plugin.data.state.activeRoleId?this.plugin.switchSession(t.id):this.plugin.startSession(t.id),this.refresh()))})}refresh(){this.stopRealtimeTimer(),this.onOpen()}createFallbackDashboard(e){e.createEl("h2",{text:"RoleSwitch Panel",cls:"fallback-dashboard-title"}),e.createEl("p",{text:"Dashboard is loading...",cls:"fallback-dashboard-loading"});let t=e.createDiv({cls:"fallback-info-container"});t.createEl("p",{text:`Roles count: ${this.plugin.data.roles.length}`}),t.createEl("p",{text:`Active role: ${this.plugin.data.state.activeRoleId||"None"}`}),t.createEl("p",{text:`Events count: ${this.plugin.data.events.length}`}),e.createEl("button",{text:"Test Dashboard",cls:"fallback-test-button"}).addEventListener("click",()=>{new b.Notice("Dashboard is working!")})}startRealtimeTimer(){this.stopRealtimeTimer(),!(!this.plugin.data.state.activeStartAt||!this.durationElement)&&(this.timerInterval=window.setInterval(()=>{this.updateDurationDisplay(),this.updateLockDisplay()},1e3))}stopRealtimeTimer(){this.timerInterval!==null&&(window.clearInterval(this.timerInterval),this.timerInterval=null)}updateDurationDisplay(){if(!this.plugin.data.state.activeStartAt||!this.durationElement){this.stopRealtimeTimer();return}let e=new Date(this.plugin.data.state.activeStartAt),t=Math.floor((Date.now()-e.getTime())/1e3),s=Math.floor(t/3600),n=Math.floor(t%3600/60),a=t%60,o;s>0?o=`${s}h ${n}m ${a}s`:n>0?o=`${n}m ${a}s`:o=`${a}s`,this.durationElement.textContent=o}updateLockDisplay(){let e=this.plugin.isSessionLocked();if(this.lockElement)if(e){let t=this.plugin.getRemainingLockTime();this.lockElement.textContent=`\u{1F512} Locked (${t}s)`}else this.lockElement.remove(),this.lockElement=null;if(this.plugin.data.state.activeRoleId){let t=this.plugin.data.state.activeRoleId,s=this.roleLockElements.get(t);if(s)if(e){let n=this.plugin.getRemainingLockTime();s.textContent=`\u{1F512} ${n}s`}else s.remove(),this.roleLockElements.delete(t)}if(this.endSessionButton)if(e){this.endSessionButton.disabled=!0,this.endSessionButton.addClass("locked");let t=this.plugin.getRemainingLockTime();this.endSessionButton.title=`Session locked for ${t} more seconds`}else this.endSessionButton.disabled=!1,this.endSessionButton.removeClass("locked"),this.endSessionButton.title=""}};var d=require("obsidian");var L=class extends d.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h1",{text:"RoleSwitch Settings"}),this.createRoleManagementSection(e),this.createSessionSettingsSection(e),this.createDisplaySettingsSection(e)}createRoleManagementSection(e){e.createEl("h2",{text:"Role Management"}),new d.Setting(e).setName("Add new role").setDesc("Create a new role for task switching").addButton(t=>{t.setButtonText("Add Role").setCta().onClick(()=>{this.showRoleEditModal()})}),this.createRolesList(e)}createRolesList(e){let t=e.createDiv({cls:"roles-list-container"});if(this.plugin.data.roles.length===0){t.createDiv({text:"No roles created yet. Add your first role above.",cls:"no-roles-message"});return}this.plugin.data.roles.forEach(s=>{this.createRoleSetting(t,s)})}createRoleSetting(e,t){let s=new d.Setting(e).setName(t.name).setDesc(t.description||"No description").addButton(a=>{a.setButtonText("Edit").onClick(()=>{this.showRoleEditModal(t)})}).addButton(a=>{a.setButtonText("Delete").setWarning().onClick(async()=>{await this.confirmDelete(t)&&(this.plugin.deleteRole(t.id),this.display())})}),n=document.createElement("div");if(n.addClass("role-color-indicator"),n.addClass("role-color-bg"),n.setCssProps({"--role-color":t.colorHex}),t.icon&&m.ICONS[t.icon]){let a=document.createElement("div");a.addClass("role-icon-container");let o=m.createIconElement(t.icon,12,"white");a.appendChild(o),n.appendChild(a)}s.nameEl.prepend(n)}createSessionSettingsSection(e){e.createEl("h2",{text:"Session Settings"});let s=new d.Setting(e).setName("Transition duration").setDesc("Time to wait before switching roles (seconds)").controlEl.createDiv({cls:"setting-item-control-flex"});[5,10,30].forEach(l=>{s.createEl("button",{text:`${l}s`,cls:"setting-preset-button"}).addEventListener("click",async()=>{this.plugin.data.settings.transitionSeconds=l,await this.plugin.savePluginData(),a.value=l.toString()})});let a=s.createEl("input",{type:"number",cls:"setting-number-input",attr:{min:"5",max:"120",step:"5"}});a.value=this.plugin.data.settings.transitionSeconds.toString(),a.addEventListener("change",async()=>{let l=parseInt(a.value);l>=5&&l<=120?(this.plugin.data.settings.transitionSeconds=l,await this.plugin.savePluginData()):a.value=this.plugin.data.settings.transitionSeconds.toString()}),s.createSpan({text:"seconds",cls:"setting-unit-label"});let r=new d.Setting(e).setName("Minimum session duration").setDesc("Minimum time before allowing role switches (minutes)").controlEl.createDiv({cls:"setting-item-control-flex"});[5,15,30].forEach(l=>{r.createEl("button",{text:`${l}m`,cls:"setting-preset-button"}).addEventListener("click",async()=>{this.plugin.data.settings.minSessionSeconds=l*60,await this.plugin.savePluginData(),c.value=l.toString()})});let c=r.createEl("input",{type:"number",cls:"setting-number-input",attr:{min:"5",max:"60",step:"5"}});c.value=(this.plugin.data.settings.minSessionSeconds/60).toString(),c.addEventListener("change",async()=>{let l=parseInt(c.value);l>=5&&l<=60?(this.plugin.data.settings.minSessionSeconds=l*60,await this.plugin.savePluginData()):c.value=(this.plugin.data.settings.minSessionSeconds/60).toString()}),r.createSpan({text:"minutes",cls:"setting-unit-label"})}createDisplaySettingsSection(e){e.createEl("h2",{text:"Display Settings"}),new d.Setting(e).setName("Show status bar").setDesc("Display current role in the status bar").addToggle(l=>{l.setValue(this.plugin.data.settings.showStatusBar).onChange(async h=>{this.plugin.data.settings.showStatusBar=h,await this.plugin.savePluginData(),this.plugin.updateStatusBar()})}),new d.Setting(e).setName("Show workspace border").setDesc("Add colored border around workspace (desktop only)").addToggle(l=>{l.setValue(this.plugin.data.settings.showWorkspaceBorder).onChange(async h=>{this.plugin.data.settings.showWorkspaceBorder=h,await this.plugin.savePluginData(),this.plugin.updateWorkspaceBorder()})});let s=new d.Setting(e).setName("Border opacity").setDesc("Opacity of the workspace border (0.1 to 1.0)").controlEl.createDiv({cls:"setting-item-control-flex"});[.3,.5,.8].forEach(l=>{s.createEl("button",{text:`${l}`,cls:"setting-preset-button"}).addEventListener("click",async()=>{this.plugin.data.settings.borderOpacity=l,await this.plugin.savePluginData(),this.plugin.updateWorkspaceBorder(),a.value=l.toString()})});let a=s.createEl("input",{type:"number",cls:"setting-number-input",attr:{min:"0.1",max:"1.0",step:"0.1"}});a.value=this.plugin.data.settings.borderOpacity.toString(),a.addEventListener("change",async()=>{let l=parseFloat(a.value);l>=.1&&l<=1?(this.plugin.data.settings.borderOpacity=l,await this.plugin.savePluginData(),this.plugin.updateWorkspaceBorder()):a.value=this.plugin.data.settings.borderOpacity.toString()}),s.createSpan({text:"opacity",cls:"setting-unit-label"}),new d.Setting(e).setName("Show periodic role reminder").setDesc("Display a periodic notification showing your current role").addToggle(l=>{l.setValue(this.plugin.data.settings.showPeriodicReminder).onChange(async h=>{this.plugin.data.settings.showPeriodicReminder=h,await this.plugin.savePluginData(),this.plugin.updateReminderInterval()})});let r=new d.Setting(e).setName("Reminder interval").setDesc("How often to show the role reminder (minutes)").controlEl.createDiv({cls:"setting-item-control-flex"});[5,15,30].forEach(l=>{r.createEl("button",{text:`${l}m`,cls:"setting-preset-button"}).addEventListener("click",async()=>{this.plugin.data.settings.reminderIntervalMinutes=l,await this.plugin.savePluginData(),this.plugin.updateReminderInterval(),c.value=l.toString()})});let c=r.createEl("input",{type:"number",cls:"setting-number-input",attr:{min:"1",max:"60",step:"1"}});c.value=this.plugin.data.settings.reminderIntervalMinutes.toString(),c.addEventListener("change",async()=>{let l=parseInt(c.value);l>=1&&l<=60?(this.plugin.data.settings.reminderIntervalMinutes=l,await this.plugin.savePluginData(),this.plugin.updateReminderInterval()):c.value=this.plugin.data.settings.reminderIntervalMinutes.toString()}),r.createSpan({text:"minutes",cls:"setting-unit-label"}),new d.Setting(e).setName("Reset settings").setDesc("Reset all settings to default values").addButton(l=>{l.setButtonText("Reset to Defaults").setWarning().onClick(async()=>{await this.confirmReset()&&(this.plugin.data.settings={...k},await this.plugin.savePluginData(),this.display(),new d.Notice("Settings reset to defaults"))})})}createApiAndSyncSettingsSection(e){e.createEl("h2",{text:"API & Synchronization Settings"}),new d.Setting(e).setName("Enable Synchronization").setDesc("Enable API server and sync functionality for external integrations and device synchronization").addToggle(t=>{t.setValue(this.plugin.data.settings.enableSync).onChange(async s=>{this.plugin.data.settings.enableSync=s,this.plugin.data.settings.enableApi=s,await this.plugin.savePluginData(),s?(await this.plugin.startApiServer(),this.plugin.sync.startAutoSync()):(await this.plugin.stopApiServer(),this.plugin.sync.stopAutoSync()),this.display()})}),this.plugin.data.settings.enableSync&&(new d.Setting(e).setName("Device Name").setDesc("Name to identify this device in sync operations").addText(t=>{t.setValue(this.plugin.data.settings.deviceName).onChange(async s=>{this.plugin.data.settings.deviceName=s||"Obsidian Device",await this.plugin.savePluginData()})}),new d.Setting(e).setName("Device ID").setDesc("Unique identifier for this device (auto-generated)").addText(t=>{t.setValue(this.plugin.data.settings.deviceId).setDisabled(!0)}),new d.Setting(e).setName("API Port").setDesc("Port number for the API server").addText(t=>{t.setValue(this.plugin.data.settings.apiPort.toString()).onChange(async s=>{let n=parseInt(s);n>=1024&&n<=65535&&(this.plugin.data.settings.apiPort=n,await this.plugin.savePluginData())})}),new d.Setting(e).setName("Enable Authentication").setDesc("Require API keys for API access (recommended)").addToggle(t=>{t.setValue(this.plugin.data.settings.enableAuthentication).onChange(async s=>{this.plugin.data.settings.enableAuthentication=s,await this.plugin.savePluginData(),this.display()})}),this.plugin.data.settings.enableAuthentication&&this.createApiKeyManagement(e),new d.Setting(e).setName("Sync Interval").setDesc("How often to sync in minutes").addSlider(t=>{t.setLimits(1,60,1).setValue(this.plugin.data.settings.syncInterval).setDynamicTooltip().onChange(async s=>{this.plugin.data.settings.syncInterval=s,await this.plugin.savePluginData(),this.plugin.sync.stopAutoSync(),this.plugin.sync.startAutoSync()})}),this.createSyncEndpointManagement(e))}createApiKeyManagement(e){e.createEl("h3",{text:"API Key Management"}),new d.Setting(e).setName("Generate API Key").setDesc("Create a new API key for external applications").addButton(s=>{s.setButtonText("Generate Key").setCta().onClick(()=>{this.showApiKeyModal()})});let t=this.plugin.data.apiKeys;if(t.length===0){let s=e.createDiv({text:"No API keys created yet.",cls:"setting-item-description"})}else t.forEach(s=>{let n=`${s.name} (${s.permissions.join(", ")})`,a=s.lastUsed?new Date(s.lastUsed).toLocaleDateString():"Never";new d.Setting(e).setName(n).setDesc(`Created: ${new Date(s.createdAt).toLocaleDateString()} | Last used: ${a}`).addButton(o=>{o.setButtonText("Delete").setWarning().onClick(async()=>{await this.confirmDeleteApiKey(s)&&(this.plugin.auth.deleteApiKey(s.id),this.display(),new d.Notice("API key deleted"))})}).addToggle(o=>{o.setValue(s.isActive).onChange(async r=>{this.plugin.auth.updateApiKey(s.id,{isActive:r}),new d.Notice(`API key ${r?"enabled":"disabled"}`)})})})}createSyncEndpointManagement(e){e.createEl("h3",{text:"Sync Endpoints"}),new d.Setting(e).setName("Add Sync Endpoint").setDesc("Connect to another RoleSwitch instance").addButton(s=>{s.setButtonText("Add Endpoint").setCta().onClick(()=>{this.showSyncEndpointModal()})});let t=this.plugin.data.syncEndpoints;t.length===0?e.createDiv({text:"No sync endpoints configured.",cls:"setting-item-description"}):t.forEach(s=>{let n=s.lastSync?new Date(s.lastSync).toLocaleString():"Never";new d.Setting(e).setName(s.name).setDesc(`URL: ${s.url} | Direction: ${s.syncDirection} | Last sync: ${n}`).addButton(a=>{a.setButtonText("Test").onClick(async()=>{let o=await this.plugin.sync.testEndpointConnection(s);new d.Notice(o.message)})}).addButton(a=>{a.setButtonText("Sync Now").onClick(async()=>{let o=await this.plugin.sync.manualSyncEndpoint(s.id);new d.Notice(o.message),o.success&&this.display()})}).addButton(a=>{a.setButtonText("Delete").setWarning().onClick(async()=>{await this.confirmDeleteEndpoint(s)&&(this.plugin.sync.deleteSyncEndpoint(s.id),this.display(),new d.Notice("Sync endpoint deleted"))})}).addToggle(a=>{a.setValue(s.isActive).onChange(async o=>{this.plugin.sync.updateSyncEndpoint(s.id,{isActive:o}),new d.Notice(`Endpoint ${o?"enabled":"disabled"}`)})})})}showRoleEditModal(e){let t=new G(this.app,this.plugin,e),s=t.onClose.bind(t);t.onClose=()=>{s(),this.display()},t.open()}async confirmDelete(e){return new Promise(t=>{let s=new x(this.app,"Delete Role",`Are you sure you want to delete the role "${e.name}"? This action cannot be undone.`,"Delete",!0);s.onConfirm=n=>t(n),s.open()})}async confirmReset(){return new Promise(e=>{let t=new x(this.app,"Reset Settings","Are you sure you want to reset all settings to defaults? This action cannot be undone.","Reset",!0);t.onConfirm=s=>e(s),t.open()})}showApiKeyModal(){let e=new d.Modal(this.app);e.titleEl.setText("Create API Key");let{contentEl:t}=e,s,n=["read"],a=new d.Setting(t).setName("Key Name").setDesc("Descriptive name for this API key").addText(c=>(s=c.inputEl,c.setPlaceholder("My App Key"),c));new d.Setting(t).setName("Permissions").setDesc("Select what this key can do").addDropdown(c=>{c.addOption("read","Read Only - View data only").addOption("write","Read/Write - Modify sessions and roles").addOption("admin","Admin - Full access including key management").setValue("read").onChange(l=>{["read","write","admin"].includes(l)&&(n=[l])})});let o=t.createDiv({cls:"modal-button-container"});o.createEl("button",{text:"Create Key",cls:"mod-cta"}).addEventListener("click",()=>{let c=s.value.trim();if(!c){new d.Notice("Key name is required");return}try{let l=this.plugin.auth.generateApiKey(c,n);new d.Notice(`API key created: ${l.key}
Secret: ${l.secret}`,1e4),e.close(),this.display()}catch(l){new d.Notice("Failed to create API key")}}),o.createEl("button",{text:"Cancel"}).addEventListener("click",()=>e.close()),e.open(),s.focus()}showSyncEndpointModal(){let e=new d.Modal(this.app);e.titleEl.setText("Add Sync Endpoint");let{contentEl:t}=e,s,n,a,o="bidirectional",r=new d.Setting(t).setName("Endpoint Name").setDesc("Name for this sync endpoint").addText(h=>(s=h.inputEl,h.setPlaceholder("Home Computer"),h));new d.Setting(t).setName("Endpoint URL").setDesc("Full URL to the other RoleSwitch API").addText(h=>{n=h.inputEl,h.setPlaceholder("http://localhost:3030")}),new d.Setting(t).setName("API Key").setDesc("Select API key to use for authentication").addDropdown(h=>{let f=this.plugin.data.apiKeys.filter(w=>w.isActive);f.length===0?h.addOption("","No active API keys available"):f.forEach(w=>{h.addOption(w.id,w.name)}),a=h.selectEl}),new d.Setting(t).setName("Sync Direction").setDesc("How data should be synchronized").addDropdown(h=>{h.addOption("push","Push Only - Send data to endpoint").addOption("pull","Pull Only - Receive data from endpoint").addOption("bidirectional","Bidirectional - Both send and receive").setValue("bidirectional").onChange(f=>{o=f})});let u=t.createDiv({cls:"modal-button-container"});u.createEl("button",{text:"Add Endpoint",cls:"mod-cta"}).addEventListener("click",()=>{let h=s.value.trim(),f=n.value.trim(),w=a.value;if(!h||!f||!w){new d.Notice("All fields are required");return}try{this.plugin.sync.addSyncEndpoint(h,f,w,o),new d.Notice("Sync endpoint added"),e.close(),this.display()}catch(R){new d.Notice("Failed to add sync endpoint")}}),u.createEl("button",{text:"Cancel"}).addEventListener("click",()=>e.close()),e.open(),s.focus()}async confirmDeleteApiKey(e){return new Promise(t=>{let s=new x(this.app,"Delete API Key",`Are you sure you want to delete the API key "${e.name}"? This action cannot be undone and any applications using this key will lose access.`,"Delete",!0);s.onConfirm=n=>t(n),s.open()})}async confirmDeleteEndpoint(e){return new Promise(t=>{let s=new x(this.app,"Delete Sync Endpoint",`Are you sure you want to delete the sync endpoint "${e.name}"?`,"Delete",!0);s.onConfirm=n=>t(n),s.open()})}createDonateSection(e){e.createEl("h2",{text:"\u{1F49D} Support Development"});let t=e.createDiv({cls:"donate-section"});t.createEl("p",{text:"If you find RoleSwitch helpful, consider supporting its development!",cls:"donate-text"}),new d.Setting(t).setName("Buy Me a Coffee").setDesc("Support development with a one-time donation").addButton(s=>{s.setButtonText("\u2615 Donate").setCta().onClick(()=>{window.open("https://www.buymeacoffee.com/yourusername","_blank")})}),new d.Setting(t).setName("GitHub Sponsors").setDesc("Become a sponsor and support ongoing development").addButton(s=>{s.setButtonText("\u{1F496} Sponsor").onClick(()=>{window.open("https://github.com/sponsors/yourusername","_blank")})}),t.createEl("p",{text:"Thank you for your support! \u2764\uFE0F",cls:"donate-thank-you"})}},G=class extends d.Modal{constructor(e,t,s){super(e);this.selectedIcon=null;this.plugin=t,this.role=s||null,this.selectedIcon=(s==null?void 0:s.icon)||null}onOpen(){let{contentEl:e}=this;e.empty();let t=this.role?"Edit Role":"Create New Role";e.createEl("h2",{text:t}),new d.Setting(e).setName("Role name").setDesc("A descriptive name for this role").addText(o=>{var r;this.nameInput=o.inputEl,o.setValue(((r=this.role)==null?void 0:r.name)||"").setPlaceholder("e.g., Deep Work, Meetings, Learning")}),new d.Setting(e).setName("Description").setDesc("Optional description of this role").addTextArea(o=>{var r;this.descriptionInput=o.inputEl,o.setValue(((r=this.role)==null?void 0:r.description)||"").setPlaceholder("Optional description..."),o.inputEl.rows=3}),new d.Setting(e).setName("Color").setDesc("Color to represent this role").addColorPicker(o=>{var c;let r=o;this.colorInput=r.inputEl||r.input;let u=((c=this.role)==null?void 0:c.colorHex)||p.generateRandomColor();o.setValue(u),this.colorComponent=r}),this.createIconSelection(e);let s=e.createDiv({cls:"role-edit-buttons"}),n=s.createEl("button",{text:"Save"});n.addClass("role-edit-save"),n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();try{this.save()}catch(r){new d.Notice("Error in save method: "+r.message)}});let a=s.createEl("button",{text:"Cancel"});a.addClass("role-edit-cancel"),a.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),this.close()}),this.nameInput.focus()}createIconSelection(e){new d.Setting(e).setName("Icon").setDesc("Optional icon for this role").addButton(t=>{t.setButtonText("Choose Icon").onClick(()=>{new M(this.app,s=>{this.selectedIcon=s,this.updateIconDisplay(t.buttonEl)},this.selectedIcon||void 0).open()}),this.updateIconDisplay(t.buttonEl)})}updateIconDisplay(e){if(e.textContent="",this.selectedIcon){let t=m.createIconElement(this.selectedIcon,16);e.appendChild(t)}else e.textContent="Choose Icon"}save(){var a,o,r,u;let e=((o=(a=this.nameInput)==null?void 0:a.value)==null?void 0:o.trim())||"",t=((u=(r=this.descriptionInput)==null?void 0:r.value)==null?void 0:u.trim())||"",s="";if(this.colorInput&&this.colorInput.value?s=this.colorInput.value:this.colorComponent&&this.colorComponent.getValue?s=this.colorComponent.getValue():s=p.generateRandomColor(),!e){new d.Notice("Role name is required");return}p.isValidHexColor(s)||(s&&typeof s=="string"?(s.startsWith("#")||(s="#"+s),p.isValidHexColor(s)||(s=p.generateRandomColor())):s=p.generateRandomColor());try{if(this.role)this.plugin.updateRole(this.role.id,{name:e,description:t||void 0,colorHex:s,icon:this.selectedIcon||void 0}),new d.Notice("Role updated");else{let c=this.plugin.createRole(e,s,t||void 0,this.selectedIcon||void 0);new d.Notice("Role created")}this.close()}catch(c){new d.Notice("Failed to save role")}}onClose(){let{contentEl:e}=this;e.empty()}},x=class extends d.Modal{constructor(e,t,s,n="Confirm",a=!1){super(e);this.onConfirm=()=>{};this.title=t,this.message=s,this.confirmText=n,this.isDestructive=a}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:this.title}),e.createEl("p",{text:this.message});let t=e.createDiv({cls:"confirm-modal-buttons"});t.createEl("button",{text:this.confirmText,cls:this.isDestructive?"confirm-button destructive":"confirm-button"}).addEventListener("click",()=>{this.close(),this.onConfirm(!0)}),t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close(),this.onConfirm(!1)})}onClose(){super.onClose()}};var H=class{constructor(i,e=3030){this.isServerRunning=!1;this.plugin=i,this.port=e}async startServer(){if(this.isServerRunning)throw new Error("API server is already running");try{this.isServerRunning=!0}catch(i){throw new Error(`Failed to start API server: ${i}`)}}async stopServer(){if(this.isServerRunning)try{this.isServerRunning=!1}catch(i){throw new Error(`Failed to stop API server: ${i}`)}}getStatus(){try{let i=this.plugin.data.state,e=i.activeRoleId?this.plugin.data.roles.find(s=>s.id===i.activeRoleId):void 0,t;if(i.activeSessionId&&i.activeStartAt){let s=Math.floor((Date.now()-new Date(i.activeStartAt).getTime())/1e3);t={id:i.activeSessionId,roleId:i.activeRoleId,startAt:i.activeStartAt,duration:s}}return{success:!0,data:{isActive:!!i.activeRoleId,currentRole:e,currentSession:t,isLocked:this.plugin.isSessionLocked(),lockTimeRemaining:this.plugin.isSessionLocked()?this.plugin.getRemainingLockTime():void 0}}}catch(i){return{success:!1,error:`Failed to get status: ${i}`}}}getRoles(){try{return{success:!0,data:this.plugin.data.roles}}catch(i){return{success:!1,error:`Failed to get roles: ${i}`}}}getRole(i){try{let e=this.plugin.data.roles.find(t=>t.id===i);return e?{success:!0,data:e}:{success:!1,error:"Role not found"}}catch(e){return{success:!1,error:`Failed to get role: ${e}`}}}createRole(i){try{return{success:!0,data:this.plugin.createRole(i.name,i.colorHex,i.description,i.icon),message:"Role created successfully"}}catch(e){return{success:!1,error:`Failed to create role: ${e}`}}}updateRole(i,e){try{return this.plugin.updateRole(i,e),{success:!0,data:this.plugin.data.roles.find(s=>s.id===i),message:"Role updated successfully"}}catch(t){return{success:!1,error:`Failed to update role: ${t}`}}}deleteRole(i){try{return this.plugin.deleteRole(i),{success:!0,message:"Role deleted successfully"}}catch(e){return{success:!1,error:`Failed to delete role: ${e}`}}}startSession(i){try{return this.plugin.startSession(i),{success:!0,message:"Session started successfully"}}catch(e){return{success:!1,error:`Failed to start session: ${e}`}}}switchSession(i){try{return this.plugin.isSessionLocked()?{success:!1,error:`Session is locked for ${this.plugin.getRemainingLockTime()} more seconds`}:(this.plugin.confirmSwitch(i),{success:!0,message:"Session switched successfully"})}catch(e){return{success:!1,error:`Failed to switch session: ${e}`}}}endSession(){try{return this.plugin.endSession(),{success:!0,message:"Session ended successfully"}}catch(i){return{success:!1,error:`Failed to end session: ${i}`}}}getSessions(i){try{let e=i!=null&&i.startDate?new Date(i.startDate):void 0,t=i!=null&&i.endDate?new Date(i.endDate):void 0,s=this.plugin.getDerivedSessions(e,t);return i!=null&&i.roleId&&(s=s.filter(n=>n.roleId===i.roleId)),{success:!0,data:s}}catch(e){return{success:!1,error:`Failed to get sessions: ${e}`}}}addNote(i){try{return{success:!0,data:this.plugin.addNote(i.sessionId,i.text),message:"Note added successfully"}}catch(e){return{success:!1,error:`Failed to add note: ${e}`}}}updateNote(i,e){try{return this.plugin.updateNote(i,e.text),{success:!0,message:"Note updated successfully"}}catch(t){return{success:!1,error:`Failed to update note: ${t}`}}}deleteNote(i){try{return this.plugin.deleteNote(i),{success:!0,message:"Note deleted successfully"}}catch(e){return{success:!1,error:`Failed to delete note: ${e}`}}}getEvents(i){try{let e=[...this.plugin.data.events];if(i!=null&&i.startDate){let t=new Date(i.startDate);e=e.filter(s=>new Date(s.at)>=t)}if(i!=null&&i.endDate){let t=new Date(i.endDate);e=e.filter(s=>new Date(s.at)<=t)}return i!=null&&i.roleId&&(e=e.filter(t=>t.roleId===i.roleId)),i!=null&&i.type&&(e=e.filter(t=>t.type===i.type)),{success:!0,data:e}}catch(e){return{success:!1,error:`Failed to get events: ${e}`}}}getAnalytics(i){try{let e=i!=null&&i.startDate?new Date(i.startDate):void 0,t=i!=null&&i.endDate?new Date(i.endDate):void 0,s=this.plugin.getDerivedSessions(e,t),n=this.plugin.data.roles,a=s.length,o=s.reduce((c,l)=>{let h=l.endAt?new Date(l.endAt).getTime():Date.now(),f=new Date(l.startAt).getTime();return c+(h-f)/1e3},0),r=new Map;n.forEach(c=>{r.set(c.id,{roleId:c.id,roleName:c.name,sessionCount:0,totalTime:0,percentage:0})}),s.forEach(c=>{let l=r.get(c.roleId);if(l){l.sessionCount++;let h=c.endAt?new Date(c.endAt).getTime():Date.now(),f=new Date(c.startAt).getTime();l.totalTime+=(h-f)/1e3}}),r.forEach(c=>{o>0&&(c.percentage=c.totalTime/o*100)});let u=new Map;return s.forEach(c=>{let l=new Date(c.startAt).toISOString().split("T")[0];u.has(l)||u.set(l,{date:l,totalTime:0,sessionCount:0});let h=u.get(l);h.sessionCount++;let f=c.endAt?new Date(c.endAt).getTime():Date.now(),w=new Date(c.startAt).getTime();h.totalTime+=(f-w)/1e3}),{success:!0,data:{totalSessions:a,totalTime:o,roleBreakdown:Array.from(r.values()),dailyBreakdown:Array.from(u.values()).sort((c,l)=>c.date.localeCompare(l.date))}}}catch(e){return{success:!1,error:`Failed to get analytics: ${e}`}}}handleSyncPush(i){try{return this.mergeSyncData(i),{success:!0,message:"Sync data pushed successfully",data:{merged:!0,timestamp:new Date().toISOString()}}}catch(e){return{success:!1,error:`Failed to handle sync push: ${e}`}}}handleSyncPull(i){try{let e=this.plugin.data.settings.deviceId||this.generateDeviceId(),t=this.plugin.data.settings.deviceName,s=[...this.plugin.data.events];if(i!=null&&i.since){let a=new Date(i.since);s=s.filter(o=>new Date(o.at)>a)}return{success:!0,data:{deviceId:e,deviceName:t,timestamp:new Date().toISOString(),roles:[...this.plugin.data.roles],events:s,state:{...this.plugin.data.state}}}}catch(e){return{success:!1,error:`Failed to handle sync pull: ${e}`}}}async handleSyncBidirectional(i){try{return this.mergeSyncData(i),{success:!0,message:"Bidirectional sync completed",data:this.handleSyncPull().data}}catch(e){return{success:!1,error:`Failed to handle bidirectional sync: ${e}`}}}mergeSyncData(i){i.roles.forEach(e=>{let t=this.plugin.data.roles.findIndex(s=>s.id===e.id);t>=0?this.plugin.data.roles[t]=e:this.plugin.data.roles.push(e)}),i.events.forEach(e=>{this.plugin.data.events.some(s=>s.id===e.id)||this.plugin.data.events.push(e)}),this.plugin.data.events.sort((e,t)=>new Date(e.at).getTime()-new Date(t.at).getTime()),i.state.activeStartAt&&(!this.plugin.data.state.activeStartAt||new Date(i.state.activeStartAt)>new Date(this.plugin.data.state.activeStartAt))&&this.plugin.data.roles.some(t=>t.id===i.state.activeRoleId)&&(this.plugin.data.state={...i.state}),this.plugin.savePluginData(),this.plugin.updateStatusBar(),this.plugin.updateWorkspaceBorder(),this.plugin.refreshSidePanel()}generateDeviceId(){let i=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);return this.plugin.data.settings.deviceId=i,this.plugin.savePluginData(),i}};var $=class{constructor(i,e){this.api=i,this.auth=e,this.routes=new Map,this.setupRoutes()}setupRoutes(){this.routes.set("GET /api/status",{handler:this.handleGetStatus.bind(this),permission:"read"}),this.routes.set("POST /api/auth/keys",{handler:this.handleCreateApiKey.bind(this),permission:"admin"}),this.routes.set("GET /api/auth/keys",{handler:this.handleGetApiKeys.bind(this),permission:"admin"}),this.routes.set("PUT /api/auth/keys/:id",{handler:this.handleUpdateApiKey.bind(this),permission:"admin"}),this.routes.set("DELETE /api/auth/keys/:id",{handler:this.handleDeleteApiKey.bind(this),permission:"admin"}),this.routes.set("GET /api/roles",{handler:this.handleGetRoles.bind(this),permission:"read"}),this.routes.set("GET /api/roles/:id",{handler:this.handleGetRole.bind(this),permission:"read"}),this.routes.set("POST /api/roles",{handler:this.handleCreateRole.bind(this),permission:"write"}),this.routes.set("PUT /api/roles/:id",{handler:this.handleUpdateRole.bind(this),permission:"write"}),this.routes.set("DELETE /api/roles/:id",{handler:this.handleDeleteRole.bind(this),permission:"write"}),this.routes.set("POST /api/sessions/start",{handler:this.handleStartSession.bind(this),permission:"write"}),this.routes.set("POST /api/sessions/switch",{handler:this.handleSwitchSession.bind(this),permission:"write"}),this.routes.set("POST /api/sessions/end",{handler:this.handleEndSession.bind(this),permission:"write"}),this.routes.set("GET /api/sessions",{handler:this.handleGetSessions.bind(this),permission:"read"}),this.routes.set("POST /api/notes",{handler:this.handleAddNote.bind(this),permission:"write"}),this.routes.set("PUT /api/notes/:id",{handler:this.handleUpdateNote.bind(this),permission:"write"}),this.routes.set("DELETE /api/notes/:id",{handler:this.handleDeleteNote.bind(this),permission:"write"}),this.routes.set("GET /api/events",{handler:this.handleGetEvents.bind(this),permission:"read"}),this.routes.set("GET /api/analytics",{handler:this.handleGetAnalytics.bind(this),permission:"read"}),this.routes.set("POST /api/sync/push",{handler:this.handleSyncPush.bind(this),permission:"write"}),this.routes.set("GET /api/sync/pull",{handler:this.handleSyncPull.bind(this),permission:"read"}),this.routes.set("POST /api/sync/bidirectional",{handler:this.handleSyncBidirectional.bind(this),permission:"write"})}async handleRequest(i){try{let e={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-API-Key, X-Timestamp, X-Signature","Content-Type":"application/json"};if(i.method==="OPTIONS")return{statusCode:200,headers:e,body:null};let t=`${i.method} ${this.extractRoutePath(i.url)}`,s=this.routes.get(t);if(!s)return{statusCode:404,headers:e,body:{success:!1,error:"Endpoint not found"}};if(s.permission){let a=this.auth.authenticateRequest(i.headers,s.permission);if(!a.isAuthenticated)return{statusCode:401,headers:e,body:{success:!1,error:a.error||"Authentication required"}};i.apiKey=a.apiKey}i.params=this.extractPathParams(i.url,t),i.query=this.extractQueryParams(i.url);let n=await s.handler(i);return n.headers={...e,...n.headers},n}catch(e){return{statusCode:500,headers:{"Content-Type":"application/json"},body:{success:!1,error:`Internal server error: ${e}`}}}}extractRoutePath(i){return i.split("?")[0].replace(/\/[^\/]+/g,t=>/^\/[a-f0-9-]{36}$/i.test(t)||/^\/\d+$/.test(t)?"/:id":t)}extractPathParams(i,e){let t={},s=i.split("?")[0].split("/"),n=e.split(" ")[1].split("/");for(let a=0;a<n.length;a++)if(n[a].startsWith(":")){let o=n[a].substring(1);t[o]=s[a]}return t}extractQueryParams(i){let e={},t=i.split("?")[1];return t&&t.split("&").forEach(s=>{let[n,a]=s.split("=");e[decodeURIComponent(n)]=decodeURIComponent(a||"")}),e}createResponse(i,e=200){return{statusCode:i.success?e:400,headers:{},body:i}}async handleGetStatus(i){let e=this.api.getStatus();return this.createResponse(e)}async handleGetRoles(i){let e=this.api.getRoles();return this.createResponse(e)}async handleGetRole(i){var s;let e=(s=i.params)==null?void 0:s.id;if(!e)return this.createResponse({success:!1,error:"Role ID is required"});let t=this.api.getRole(e);return this.createResponse(t)}async handleCreateRole(i){if(!i.body)return this.createResponse({success:!1,error:"Request body is required"});let e=this.api.createRole(i.body);return this.createResponse(e,201)}async handleUpdateRole(i){var s;let e=(s=i.params)==null?void 0:s.id;if(!e)return this.createResponse({success:!1,error:"Role ID is required"});if(!i.body)return this.createResponse({success:!1,error:"Request body is required"});let t=this.api.updateRole(e,i.body);return this.createResponse(t)}async handleDeleteRole(i){var s;let e=(s=i.params)==null?void 0:s.id;if(!e)return this.createResponse({success:!1,error:"Role ID is required"});let t=this.api.deleteRole(e);return this.createResponse(t)}async handleStartSession(i){let{roleId:e}=i.body||{};if(!e)return this.createResponse({success:!1,error:"Role ID is required"});let t=this.api.startSession(e);return this.createResponse(t)}async handleSwitchSession(i){let{roleId:e}=i.body||{};if(!e)return this.createResponse({success:!1,error:"Role ID is required"});let t=this.api.switchSession(e);return this.createResponse(t)}async handleEndSession(i){let e=this.api.endSession();return this.createResponse(e)}async handleGetSessions(i){var s,n,a;let e={startDate:(s=i.query)==null?void 0:s.startDate,endDate:(n=i.query)==null?void 0:n.endDate,roleId:(a=i.query)==null?void 0:a.roleId},t=this.api.getSessions(e);return this.createResponse(t)}async handleAddNote(i){if(!i.body)return this.createResponse({success:!1,error:"Request body is required"});let e=this.api.addNote(i.body);return this.createResponse(e,201)}async handleUpdateNote(i){var s;let e=(s=i.params)==null?void 0:s.id;if(!e)return this.createResponse({success:!1,error:"Note ID is required"});if(!i.body)return this.createResponse({success:!1,error:"Request body is required"});let t=this.api.updateNote(e,i.body);return this.createResponse(t)}async handleDeleteNote(i){var s;let e=(s=i.params)==null?void 0:s.id;if(!e)return this.createResponse({success:!1,error:"Note ID is required"});let t=this.api.deleteNote(e);return this.createResponse(t)}async handleGetEvents(i){var a,o,r,u;let e=(a=i.query)==null?void 0:a.type,t=["start","end","switch","cancelTransition"],s={startDate:(o=i.query)==null?void 0:o.startDate,endDate:(r=i.query)==null?void 0:r.endDate,roleId:(u=i.query)==null?void 0:u.roleId,type:e&&t.includes(e)?e:void 0},n=this.api.getEvents(s);return this.createResponse(n)}async handleGetAnalytics(i){var s,n;let e={startDate:(s=i.query)==null?void 0:s.startDate,endDate:(n=i.query)==null?void 0:n.endDate},t=this.api.getAnalytics(e);return this.createResponse(t)}async handleCreateApiKey(i){if(!i.body)return this.createResponse({success:!1,error:"Request body is required"});let{name:e,permissions:t}=i.body;if(!e||!t)return this.createResponse({success:!1,error:"Name and permissions are required"});try{let s=this.auth.generateApiKey(e,t);return this.createResponse({success:!0,data:s},201)}catch(s){return this.createResponse({success:!1,error:`Failed to create API key: ${s}`})}}async handleGetApiKeys(i){try{let e=this.auth.getApiKeys();return this.createResponse({success:!0,data:e})}catch(e){return this.createResponse({success:!1,error:`Failed to get API keys: ${e}`})}}async handleUpdateApiKey(i){var t;let e=(t=i.params)==null?void 0:t.id;if(!e)return this.createResponse({success:!1,error:"API key ID is required"});if(!i.body)return this.createResponse({success:!1,error:"Request body is required"});try{return this.auth.updateApiKey(e,i.body),this.createResponse({success:!0,message:"API key updated successfully"})}catch(s){return this.createResponse({success:!1,error:`Failed to update API key: ${s}`})}}async handleDeleteApiKey(i){var t;let e=(t=i.params)==null?void 0:t.id;if(!e)return this.createResponse({success:!1,error:"API key ID is required"});try{return this.auth.deleteApiKey(e),this.createResponse({success:!0,message:"API key deleted successfully"})}catch(s){return this.createResponse({success:!1,error:`Failed to delete API key: ${s}`})}}async handleSyncPush(i){if(!i.body)return this.createResponse({success:!1,error:"Request body is required"});try{let e=await this.api.handleSyncPush(i.body);return this.createResponse(e)}catch(e){return this.createResponse({success:!1,error:`Sync push failed: ${e}`})}}async handleSyncPull(i){var e,t;try{let s={since:(e=i.query)==null?void 0:e.since,deviceId:(t=i.query)==null?void 0:t.deviceId},n=this.api.handleSyncPull(s);return this.createResponse(n)}catch(s){return this.createResponse({success:!1,error:`Sync pull failed: ${s}`})}}async handleSyncBidirectional(i){if(!i.body)return this.createResponse({success:!1,error:"Request body is required"});try{let e=await this.api.handleSyncBidirectional(i.body);return this.createResponse(e)}catch(e){return this.createResponse({success:!1,error:`Bidirectional sync failed: ${e}`})}}};var O=class{constructor(i){this.plugin=i}generateApiKey(i,e){let t={id:p.generateId(),name:i,key:this.generateRandomKey(32),secret:this.generateRandomKey(64),createdAt:new Date().toISOString(),permissions:e,isActive:!0};return this.plugin.data.apiKeys.push(t),this.plugin.savePluginData(),t}generateRandomKey(i){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let s=0;s<i;s++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}updateApiKey(i,e){let t=this.plugin.data.apiKeys.find(s=>s.id===i);if(!t)throw new Error("API key not found");Object.assign(t,e),this.plugin.savePluginData()}deleteApiKey(i){this.plugin.data.apiKeys=this.plugin.data.apiKeys.filter(e=>e.id!==i),this.plugin.savePluginData()}getApiKeys(){return this.plugin.data.apiKeys.map(i=>({...i,secret:"***HIDDEN***"}))}getApiKey(i){return this.plugin.data.apiKeys.find(e=>e.id===i)||null}validateApiKey(i,e){if(!this.plugin.data.settings.enableAuthentication)return null;let t=this.plugin.data.apiKeys.find(s=>s.key===i&&s.isActive);return!t||e&&!t.permissions.includes(e)&&!t.permissions.includes("admin")?null:(t.lastUsed=new Date().toISOString(),this.plugin.savePluginData(),t)}authenticateRequest(i,e){if(!this.plugin.data.settings.enableAuthentication)return{isAuthenticated:!0};let t=i.authorization||i.Authorization,s=i["x-api-key"]||i["X-API-Key"],n=null;if(t&&t.startsWith("Bearer ")?n=t.substring(7):s&&(n=s),!n)return{isAuthenticated:!1,error:"API key required. Provide via Authorization: Bearer <key> or X-API-Key header"};let a=this.validateApiKey(n,e);return a?{isAuthenticated:!0,apiKey:a}:{isAuthenticated:!1,error:"Invalid API key or insufficient permissions"}}generateSignature(i,e){let t=0,s=i+e;for(let n=0;n<s.length;n++){let a=s.charCodeAt(n);t=(t<<5)-t+a,t=t&t}return Math.abs(t).toString(16)}verifySignature(i,e,t){return this.generateSignature(i,t)===e}createAuthenticatedRequest(i,e){let t=Date.now().toString(),s=JSON.stringify(e),n=`${t}${s}`,a=this.generateSignature(n,i.secret);return{headers:{"Content-Type":"application/json","X-API-Key":i.key,"X-Timestamp":t,"X-Signature":a},body:s}}verifyAuthenticatedRequest(i,e){let t=i["x-api-key"]||i["X-API-Key"],s=i["x-timestamp"]||i["X-Timestamp"],n=i["x-signature"]||i["X-Signature"];if(!t||!s||!n)return{isValid:!1,error:"Missing authentication headers (X-API-Key, X-Timestamp, X-Signature)"};let a=this.plugin.data.apiKeys.find(l=>l.key===t&&l.isActive);if(!a)return{isValid:!1,error:"Invalid API key"};let o=parseInt(s),r=Date.now();if(Math.abs(r-o)>3e5)return{isValid:!1,error:"Request timestamp too old"};let c=`${s}${e}`;return this.verifySignature(c,n,a.secret)?(a.lastUsed=new Date().toISOString(),this.plugin.savePluginData(),{isValid:!0,apiKey:a}):{isValid:!1,error:"Invalid signature"}}};var T=require("obsidian"),K=class{constructor(i,e){this.syncIntervalId=null;this.plugin=i,this.auth=e}addSyncEndpoint(i,e,t,s){let n={id:this.generateId(),name:i,url:e.replace(/\/$/,""),apiKey:t,isActive:!0,syncDirection:s};return this.plugin.data.syncEndpoints.push(n),this.plugin.savePluginData(),n}updateSyncEndpoint(i,e){let t=this.plugin.data.syncEndpoints.find(s=>s.id===i);if(!t)throw new Error("Sync endpoint not found");Object.assign(t,e),this.plugin.savePluginData()}deleteSyncEndpoint(i){this.plugin.data.syncEndpoints=this.plugin.data.syncEndpoints.filter(e=>e.id!==i),this.plugin.savePluginData()}getSyncEndpoints(){return this.plugin.data.syncEndpoints}startAutoSync(){if(this.syncIntervalId||!this.plugin.data.settings.enableSync)return;let i=this.plugin.data.settings.syncInterval*60*1e3;this.syncIntervalId=window.setInterval(()=>{this.syncAllEndpoints()},i)}stopAutoSync(){this.syncIntervalId&&(clearInterval(this.syncIntervalId),this.syncIntervalId=null)}async syncAllEndpoints(){let i=this.plugin.data.syncEndpoints.filter(e=>e.isActive);for(let e of i)try{await this.syncWithEndpoint(e)}catch(t){}}async syncWithEndpoint(i){let e=this.plugin.data.apiKeys.find(t=>t.id===i.apiKey);if(!e)throw new Error(`API key not found for endpoint: ${i.name}`);switch(i.syncDirection){case"push":await this.pushToEndpoint(i,e);break;case"pull":await this.pullFromEndpoint(i,e);break;case"bidirectional":await this.bidirectionalSyncWithEndpoint(i,e);break}i.lastSync=new Date().toISOString(),this.plugin.savePluginData()}async pushToEndpoint(i,e){let s={deviceId:this.plugin.data.settings.deviceId||this.generateDeviceId(),deviceName:this.plugin.data.settings.deviceName,timestamp:new Date().toISOString(),roles:[...this.plugin.data.roles],events:[...this.plugin.data.events],state:{...this.plugin.data.state}},n=this.auth.createAuthenticatedRequest(e,s);await(0,T.requestUrl)({url:`${i.url}/api/sync/push`,method:"POST",headers:n.headers,body:n.body})}async pullFromEndpoint(i,e){let t=i.lastSync||new Date(0).toISOString(),s=this.plugin.data.settings.deviceId,n=this.auth.createAuthenticatedRequest(e,{}),a=await(0,T.requestUrl)({url:`${i.url}/api/sync/pull?since=${encodeURIComponent(t)}&deviceId=${encodeURIComponent(s)}`,method:"GET",headers:{"X-API-Key":e.key,"Content-Type":"application/json"}});a.json.success&&a.json.data&&this.mergeSyncData(a.json.data)}async bidirectionalSyncWithEndpoint(i,e){let s={deviceId:this.plugin.data.settings.deviceId||this.generateDeviceId(),deviceName:this.plugin.data.settings.deviceName,timestamp:new Date().toISOString(),roles:[...this.plugin.data.roles],events:[...this.plugin.data.events],state:{...this.plugin.data.state}},n=this.auth.createAuthenticatedRequest(e,s),a=await(0,T.requestUrl)({url:`${i.url}/api/sync/bidirectional`,method:"POST",headers:n.headers,body:n.body});a.json.success&&a.json.data&&this.mergeSyncData(a.json.data)}async testEndpointConnection(i){try{let e=this.plugin.data.apiKeys.find(s=>s.id===i.apiKey);if(!e)return{success:!1,message:"API key not found"};let t=await(0,T.requestUrl)({url:`${i.url}/api/status`,method:"GET",headers:{"X-API-Key":e.key,"Content-Type":"application/json"}});return t.json.success?{success:!0,message:"Connection successful"}:{success:!1,message:t.json.error||"Unknown error"}}catch(e){return{success:!1,message:`Connection failed: ${e}`}}}async manualSyncEndpoint(i){try{let e=this.plugin.data.syncEndpoints.find(t=>t.id===i);return e?(await this.syncWithEndpoint(e),{success:!0,message:`Successfully synced with ${e.name}`}):{success:!1,message:"Endpoint not found"}}catch(e){return{success:!1,message:`Sync failed: ${e}`}}}mergeSyncData(i){i.roles.forEach(t=>{let s=this.plugin.data.roles.findIndex(n=>n.id===t.id);s>=0?this.plugin.data.roles[s]=t:this.plugin.data.roles.push(t)});let e=[];i.events.forEach(t=>{this.plugin.data.events.some(n=>n.id===t.id)||e.push(t)}),this.plugin.data.events.push(...e),this.plugin.data.events.sort((t,s)=>new Date(t.at).getTime()-new Date(s.at).getTime()),i.state.activeStartAt&&(!this.plugin.data.state.activeStartAt||new Date(i.state.activeStartAt)>new Date(this.plugin.data.state.activeStartAt))&&this.plugin.data.roles.some(s=>s.id===i.state.activeRoleId)&&(this.plugin.data.state={...i.state}),this.plugin.savePluginData(),this.plugin.updateStatusBar(),this.plugin.updateWorkspaceBorder(),this.plugin.refreshSidePanel()}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}generateDeviceId(){let i=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);return this.plugin.data.settings.deviceId=i,this.plugin.savePluginData(),i}getSyncStatus(){let i=this.plugin.data.syncEndpoints.filter(t=>t.isActive),e={};return i.forEach(t=>{t.lastSync&&(e[t.name]=t.lastSync)}),{isAutoSyncEnabled:this.plugin.data.settings.enableSync,activeEndpoints:i.length,lastSyncTimes:e}}};var q=class extends y.Plugin{constructor(){super(...arguments);this.statusBarItem=null;this.borderEl=null;this.reminderInterval=null}async onload(){if(await this.loadPluginData(),this.registerView(I,e=>new P(e,this)),this.addRibbonIcon("clock","RoleSwitch Panel",()=>{this.activateView()}),this.registerCommands(),this.addSettingTab(new L(this.app,this)),this.updateStatusBar(),this.updateWorkspaceBorder(),this.auth=new O(this),this.api=new H(this,this.data.settings.apiPort||3030),this.httpServer=new $(this.api,this.auth),this.sync=new K(this,this.auth),this.data.settings.deviceId||(this.data.settings.deviceId=this.generateDeviceId(),this.savePluginData()),this.data.settings.enableApi)try{await this.api.startServer()}catch(e){}this.data.settings.enableSync&&this.sync.startAutoSync(),this.registerInterval(window.setInterval(()=>{this.savePluginData()},6e4)),this.registerDomEvent(document,"visibilitychange",()=>{document.hidden&&this.savePluginData()}),this.registerDomEvent(window,"beforeunload",()=>{this.savePluginData()})}async onunload(){if(await this.savePluginData(),this.removeStatusBar(),this.removeWorkspaceBorder(),this.stopReminderInterval(),this.sync&&this.sync.stopAutoSync(),this.api)try{await this.api.stopServer()}catch(e){}}async loadPluginData(){let e={roles:[],events:[],state:{activeRoleId:null,activeSessionId:null,activeStartAt:null,inTransition:!1,lockUntil:null},settings:{...k},apiKeys:[],syncEndpoints:[]};this.data=Object.assign(e,await this.loadData())}async savePluginData(){try{await this.saveData(this.data)}catch(e){new y.Notice("RoleSwitch: Failed to save data.")}}getRoleById(e){let t=this.data.roles.find(s=>s.id===e);return t||{id:e,name:"(Deleted Role)",colorHex:"#888888",description:"This role has been deleted"}}createRole(e,t,s,n){let a={id:p.generateId(),name:e,colorHex:t,description:s,icon:n};return this.data.roles.push(a),this.savePluginData(),this.refreshSidePanel(),a}updateRole(e,t){let s=this.data.roles.find(n=>n.id===e);if(!s)throw new Error("Role not found");Object.assign(s,t),this.savePluginData(),this.refreshSidePanel(),this.updateStatusBar(),this.updateWorkspaceBorder()}deleteRole(e){this.data.state.activeRoleId===e&&this.endSession(),this.data.roles=this.data.roles.filter(t=>t.id!==e),this.savePluginData(),this.refreshSidePanel()}startSession(e){let t=this.data.roles.find(a=>a.id===e);if(!t){new y.Notice("Role not found");return}this.data.state.activeRoleId&&this.endSession();let s=p.generateId(),n=new Date().toISOString();this.data.state={activeRoleId:e,activeSessionId:s,activeStartAt:n,inTransition:!1,lockUntil:new Date(Date.now()+this.data.settings.minSessionSeconds*1e3).toISOString()},this.data.events.push({id:p.generateId(),type:"start",roleId:e,at:n,meta:{sessionId:s}}),this.savePluginData(),this.updateStatusBar(),this.updateWorkspaceBorder(),this.refreshSidePanel(),this.updateReminderInterval(),new y.Notice(`Started ${t.name} session`)}switchSession(e){let t=this.data.roles.find(s=>s.id===e);if(!t){new y.Notice("Role not found");return}if(this.data.state.activeRoleId===e){new y.Notice("Already in this role");return}if(this.isSessionLocked()){let s=this.getRemainingLockTime();new y.Notice(`Session locked for ${s} more seconds`);return}new A(this.app,this,t).open()}confirmSwitch(e){let t=this.data.roles.find(a=>a.id===e);if(!t)return;let s=new Date().toISOString(),n=p.generateId();this.data.events.push({id:p.generateId(),type:"switch",roleId:e,at:s,meta:{sessionId:n,fromRoleId:this.data.state.activeRoleId||void 0}}),this.data.state={activeRoleId:e,activeSessionId:n,activeStartAt:s,inTransition:!1,lockUntil:new Date(Date.now()+this.data.settings.minSessionSeconds*1e3).toISOString()},this.savePluginData(),this.updateStatusBar(),this.updateWorkspaceBorder(),this.refreshSidePanel(),this.updateReminderInterval(),new y.Notice(`Switched to ${t.name}`)}endSession(){if(!this.data.state.activeRoleId){new y.Notice("No active session");return}let e=this.data.roles.find(s=>s.id===this.data.state.activeRoleId),t=new Date().toISOString();this.data.events.push({id:p.generateId(),type:"end",roleId:this.data.state.activeRoleId,at:t,meta:{sessionId:this.data.state.activeSessionId||void 0,duration:this.data.state.activeStartAt?(Date.now()-new Date(this.data.state.activeStartAt).getTime())/1e3:void 0}}),this.data.state={activeRoleId:null,activeSessionId:null,activeStartAt:null,inTransition:!1,lockUntil:null},this.savePluginData(),this.updateStatusBar(),this.updateWorkspaceBorder(),this.refreshSidePanel(),this.stopReminderInterval(),new y.Notice(`Ended ${(e==null?void 0:e.name)||"session"}`)}isSessionLocked(){return this.data.state.lockUntil?new Date<new Date(this.data.state.lockUntil):!1}getRemainingLockTime(){if(!this.data.state.lockUntil)return 0;let e=Math.max(0,new Date(this.data.state.lockUntil).getTime()-Date.now());return Math.ceil(e/1e3)}getDerivedSessions(e,t){return p.deriveSessionsFromEvents(this.data.events,e,t)}addNote(e,t){let s={id:p.generateId(),text:t,createdAt:new Date().toISOString()},a=this.getDerivedSessions().find(o=>o.id===e);return a&&a.notes.push(s),this.savePluginData(),s}updateNote(e,t){let s=this.getDerivedSessions();for(let n of s){let a=n.notes.find(o=>o.id===e);if(a){a.text=t,this.savePluginData();return}}throw new Error("Note not found")}deleteNote(e){let t=this.getDerivedSessions();for(let s of t){let n=s.notes.findIndex(a=>a.id===e);if(n!==-1){s.notes.splice(n,1),this.savePluginData();return}}throw new Error("Note not found")}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(I)[0];if(!t){let s=e.getLeftLeaf(!1);if(s)t=s,await t.setViewState({type:I,active:!0});else return}t&&e.revealLeaf(t)}refreshSidePanel(){this.app.workspace.getLeavesOfType(I).forEach(t=>{t.view instanceof P&&t.view.refresh()})}updateStatusBar(){if(!this.data.settings.showStatusBar){this.removeStatusBar();return}if(this.statusBarItem||(this.statusBarItem=this.addStatusBarItem(),this.statusBarItem.addClass("status-bar-item")),this.data.state.activeRoleId){let e=this.data.roles.find(t=>t.id===this.data.state.activeRoleId);e&&(this.statusBarItem.setText(`\u{1F3AF} ${e.name}`),this.statusBarItem.addClass("role-active"),this.statusBarItem.setCssProps({"--role-color":e.colorHex}))}else this.statusBarItem.setText("\u23F8\uFE0F No active role"),this.statusBarItem.addClass("role-inactive")}removeStatusBar(){this.statusBarItem&&(this.statusBarItem.remove(),this.statusBarItem=null)}updateWorkspaceBorder(){if(this.removeWorkspaceBorder(),!this.data.settings.showWorkspaceBorder||!this.data.state.activeRoleId)return;let e=this.data.roles.find(s=>s.id===this.data.state.activeRoleId);if(!e)return;this.borderEl=document.createElement("div"),this.borderEl.addClass("workspace-border"),this.borderEl.setCssProps({"--role-color":e.colorHex,"--border-opacity":this.data.settings.borderOpacity.toString()}),this.borderEl.setAttribute("data-role-switch-border","true"),(document.querySelector(".app-container")||document.body).appendChild(this.borderEl)}removeWorkspaceBorder(){this.borderEl&&(this.borderEl.remove(),this.borderEl=null)}registerCommands(){this.addCommand({id:"open-panel",name:"Open panel",callback:()=>{this.activateView()}}),this.addCommand({id:"open-dashboard",name:"Open dashboard",callback:()=>{new E(this.app,this).open()}}),this.addCommand({id:"start-session",name:"Start session",callback:()=>{new C(this.app,this,"start").open()}}),this.addCommand({id:"switch-session",name:"Switch session",callback:()=>{if(!this.data.state.activeRoleId){new y.Notice("No active session to switch from");return}new C(this.app,this,"switch").open()}}),this.addCommand({id:"end-session",name:"End current session",callback:()=>{this.endSession()}}),this.addCommand({id:"add-note",name:"Add note to current session",callback:()=>{if(!this.data.state.activeSessionId){new y.Notice("No active session to add note to");return}new B(this.app,this,this.data.state.activeSessionId,null).open()}}),this.addCommand({id:"start-api-server",name:"Start API server",callback:async()=>{if(!this.api){new y.Notice("API not initialized");return}try{await this.api.startServer(),new y.Notice("API server started successfully")}catch(e){new y.Notice(`Failed to start API server: ${e}`)}}}),this.addCommand({id:"stop-api-server",name:"Stop API server",callback:async()=>{if(!this.api){new y.Notice("API not initialized");return}try{await this.api.stopServer(),new y.Notice("API server stopped successfully")}catch(e){new y.Notice(`Failed to stop API server: ${e}`)}}})}getApiStatus(){return this.api?this.api.getStatus():null}async startApiServer(){this.api&&await this.api.startServer()}async stopApiServer(){this.api&&await this.api.stopServer()}handleApiRequest(e,t,s,n){return this.httpServer?this.httpServer.handleRequest({method:e,url:t,headers:s,body:n}):{statusCode:503,headers:{"Content-Type":"application/json"},body:{success:!1,error:"API server not initialized"}}}generateDeviceId(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}updateReminderInterval(){this.stopReminderInterval(),this.data.settings.showPeriodicReminder&&this.data.state.activeRoleId&&this.startReminderInterval()}startReminderInterval(){if(!this.data.settings.showPeriodicReminder||!this.data.state.activeRoleId)return;let e=this.data.settings.reminderIntervalMinutes*60*1e3;this.showRoleReminder(),this.reminderInterval=this.registerInterval(window.setInterval(()=>{this.showRoleReminder()},e))}stopReminderInterval(){this.reminderInterval!==null&&(window.clearInterval(this.reminderInterval),this.reminderInterval=null)}showRoleReminder(){if(!this.data.state.activeRoleId)return;let e=this.data.roles.find(n=>n.id===this.data.state.activeRoleId);if(!e)return;let t=document.createDocumentFragment(),s=document.createElement("span");s.addClass("role-color-bold"),s.setCssProps({"--role-color":e.colorHex}),s.textContent=`You are now playing the role of '${e.name}'. Don't forget, you are playing the role of '${e.name}'.`,t.appendChild(s),new y.Notice(t,8e3)}};
